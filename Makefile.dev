# ê°œë°œ í™˜ê²½ìš© Makefile
# ë¡œì»¬ ê°œë°œ PCì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´ ëª¨ìŒ

.PHONY: dev-vllm-setup dev-vllm-start dev-vllm-stop dev-vllm-logs dev-vllm-status

# ============================================================
# ê°œë°œ í™˜ê²½ vLLM ì„¤ì •
# ============================================================

dev-vllm-setup:
	@echo "ğŸ”§ ê°œë°œ í™˜ê²½ vLLM ìë™ ì„¤ì • ì¤‘..."
	@./scripts/setup-dev-vllm.sh

dev-vllm-setup-cpu:
	@echo "ğŸ”§ CPU ëª¨ë“œë¡œ ê°•ì œ ì„¤ì • ì¤‘..."
	@./scripts/setup-dev-vllm.sh --force-cpu

dev-vllm-setup-gpu:
	@echo "ğŸ”§ GPU ëª¨ë“œë¡œ ê°•ì œ ì„¤ì • ì¤‘..."
	@./scripts/setup-dev-vllm.sh --force-gpu

# ============================================================
# ê°œë°œ í™˜ê²½ vLLM ì‹¤í–‰
# ============================================================

dev-vllm-start:
	@echo "ğŸš€ ê°œë°œ í™˜ê²½ vLLM ì„œë²„ ì‹œì‘ ì¤‘..."
	@echo "ğŸ” vLLM ì„¤ì • ìë™ ê°ì§€ ì¤‘..."
	@./scripts/auto-detect-vllm.sh || true
	@if [ -f .env ] && grep -q "^VLLM_MODE=cpu" .env 2>/dev/null; then \
		echo "CPU ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤..."; \
		docker compose -f docker-compose.yml -f docker-compose.vllm-cpu.yml up -d vllm; \
	else \
		echo "GPU ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤..."; \
		docker compose --profile gpu -f docker-compose.yml -f docker-compose.vllm.yml up -d vllm || \
		(echo "âš ï¸  GPU ëª¨ë“œ ì‹œì‘ ì‹¤íŒ¨. CPU ëª¨ë“œë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤..."; \
		 echo "VLLM_MODE=cpu" >> .env 2>/dev/null || true; \
		 docker compose -f docker-compose.yml -f docker-compose.vllm-cpu.yml up -d vllm); \
	fi
	@echo "âœ… vLLM ì„œë²„ ì‹œì‘ ì™„ë£Œ"
	@echo "ìƒíƒœ í™•ì¸: make dev-vllm-status"

dev-vllm-stop:
	@echo "â¹ï¸  ê°œë°œ í™˜ê²½ vLLM ì„œë²„ ì¤‘ì§€ ì¤‘..."
	@docker compose -f docker-compose.yml -f docker-compose.vllm.yml stop vllm 2>/dev/null || true
	@docker compose -f docker-compose.yml -f docker-compose.vllm-cpu.yml stop vllm 2>/dev/null || true
	@echo "âœ… vLLM ì„œë²„ ì¤‘ì§€ ì™„ë£Œ"

dev-vllm-restart: dev-vllm-stop dev-vllm-start

dev-vllm-logs:
	@echo "ğŸ“‹ ê°œë°œ í™˜ê²½ vLLM ì„œë²„ ë¡œê·¸:"
	@docker compose logs vllm --tail 50 -f

dev-vllm-status:
	@echo "ğŸ“Š ê°œë°œ í™˜ê²½ vLLM ì„œë²„ ìƒíƒœ:"
	@docker compose ps vllm 2>/dev/null || echo "vLLM ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
	@echo ""
	@if [ -f .env ]; then \
		echo "í˜„ì¬ ì„¤ì • (.env):"; \
		grep "^VLLM" .env 2>/dev/null || echo "  VLLM ì„¤ì • ì—†ìŒ"; \
	else \
		echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. 'make dev-vllm-setup' ì‹¤í–‰í•˜ì„¸ìš”."; \
	fi

# ============================================================
# ê°œë°œ í™˜ê²½ ì „ì²´ ì‹œì‘
# ============================================================

dev-start:
	@echo "ğŸš€ ê°œë°œ í™˜ê²½ ì „ì²´ ì‹œì‘ ì¤‘..."
	@docker compose up -d postgres redis api web
	@echo "âœ… ê¸°ë³¸ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
	@echo ""
	@echo "vLLM ì„œë²„ë¥¼ ì‹œì‘í•˜ë ¤ë©´:"
	@echo "  make dev-vllm-setup  # ë¨¼ì € ì„¤ì •"
	@echo "  make dev-vllm-start  # ê·¸ ë‹¤ìŒ ì‹œì‘"

dev-stop:
	@echo "â¹ï¸  ê°œë°œ í™˜ê²½ ì „ì²´ ì¤‘ì§€ ì¤‘..."
	@docker compose down
	@docker compose -f docker-compose.yml -f docker-compose.vllm.yml down 2>/dev/null || true
	@docker compose -f docker-compose.yml -f docker-compose.vllm-cpu.yml down 2>/dev/null || true
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"

dev-status:
	@echo "ğŸ“Š ê°œë°œ í™˜ê²½ ì „ì²´ ìƒíƒœ:"
	@docker compose ps
	@echo ""
	@make dev-vllm-status

# ============================================================
# ë„ì›€ë§
# ============================================================

dev-help:
	@echo "ê°œë°œ í™˜ê²½ ëª…ë ¹ì–´:"
	@echo ""
	@echo "ì„¤ì •:"
	@echo "  make dev-vllm-setup       - GPU/CPU ìë™ ê°ì§€ ë° ì„¤ì •"
	@echo "  make dev-vllm-setup-cpu   - CPU ëª¨ë“œ ê°•ì œ ì„¤ì •"
	@echo "  make dev-vllm-setup-gpu   - GPU ëª¨ë“œ ê°•ì œ ì„¤ì •"
	@echo ""
	@echo "ì‹¤í–‰:"
	@echo "  make dev-vllm-start       - vLLM ì„œë²„ ì‹œì‘"
	@echo "  make dev-vllm-stop        - vLLM ì„œë²„ ì¤‘ì§€"
	@echo "  make dev-vllm-restart     - vLLM ì„œë²„ ì¬ì‹œì‘"
	@echo ""
	@echo "í™•ì¸:"
	@echo "  make dev-vllm-status      - vLLM ì„œë²„ ìƒíƒœ í™•ì¸"
	@echo "  make dev-vllm-logs        - vLLM ì„œë²„ ë¡œê·¸ í™•ì¸"
	@echo ""
	@echo "ì „ì²´:"
	@echo "  make dev-start            - ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘"
	@echo "  make dev-stop             - ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make dev-status           - ì „ì²´ ìƒíƒœ í™•ì¸"

