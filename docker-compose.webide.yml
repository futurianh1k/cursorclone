# VDE Web IDE Platform - 신규 서비스
# 기존 docker-compose.yml과 함께 사용
# 
# 사용법:
#   GPU 환경: docker compose -f docker-compose.yml -f docker-compose.webide.yml --profile gpu up -d
#   CPU 환경: docker compose -f docker-compose.yml -f docker-compose.webide.yml --profile cpu up -d
#   인증 포함: docker compose -f docker-compose.yml -f docker-compose.webide.yml --profile gpu --profile auth up -d

services:
  # ===========================================
  # Web IDE (code-server) - PoC 공유 인스턴스
  # ===========================================
  code-server:
    build:
      context: ./docker/code-server
      dockerfile: Dockerfile
    image: cursor-poc-code-server:latest
    container_name: cursor-poc-code-server
    environment:
      PASSWORD: ${CODE_SERVER_PASSWORD:-cursor}
      TABBY_ENDPOINT: http://cursor-poc-tabby:8080
      LITELLM_ENDPOINT: http://cursor-poc-litellm:4000
      TZ: Asia/Seoul
    volumes:
      # 워크스페이스 마운트
      - ${WORKSPACE_BASE_PATH:-./workspaces}:/home/coder/project
      # Continue 설정 (동적 업데이트용)
      - ./docker/code-server/continue-config.json:/home/coder/.continue/config.json:ro
    ports:
      - "${CODE_SERVER_PORT:-8443}:8080"
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      - litellm
  # ===========================================
  # Reverse Proxy (Nginx)
  # ===========================================
  nginx:
    image: nginx:1.25-alpine
    container_name: cursor-poc-nginx
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - code-server
      - litellm
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Authentication (Keycloak) - SSO/MFA
  # ===========================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: cursor-poc-keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_PROXY: edge
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
    ports:
      - "${KEYCLOAK_PORT:-8180}:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\nHost: localhost\\n\\n' >&3 && cat <&3 | grep -q '200'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    profiles:
      - auth

  # ===========================================
  # AI Autocomplete (Tabby) - GPU 모드
  # ===========================================
  tabby:
    image: tabbyml/tabby:0.21.0
    container_name: cursor-poc-tabby
    command: serve --model StarCoder2-3B --device cuda
    environment:
      TABBY_DISABLE_USAGE_COLLECTION: "1"
    volumes:
      - tabby_data:/data
      - ${HF_HOME:-~/.cache/huggingface}:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    ports:
      - "${TABBY_PORT:-8081}:8080"
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    profiles:
      - gpu

  # ===========================================
  # AI Autocomplete (Tabby) - CPU 모드
  # 소규모 테스트/개발용 (GPU 없는 환경)
  # ===========================================
  tabby-cpu:
    image: tabbyml/tabby:0.21.0
    container_name: cursor-poc-tabby
    command: serve --model StarCoder2-3B --device cpu
    environment:
      TABBY_DISABLE_USAGE_COLLECTION: "1"
    volumes:
      - tabby_data:/data
      - ${HF_HOME:-~/.cache/huggingface}:/root/.cache/huggingface
    ports:
      - "${TABBY_PORT:-8081}:8080"
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    profiles:
      - cpu

  # ===========================================
  # LLM Gateway (LiteLLM Proxy)
  # 역할: 정책/감사/라우팅
  # ===========================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: cursor-poc-litellm
    command: --config /app/config.yaml --port 4000
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-cursor-poc-key}
      # 프롬프트/응답 본문 로깅 비활성화 (보안)
      LITELLM_LOG_REQUEST_BODY: "false"
      LITELLM_LOG_RESPONSE_BODY: "false"
    volumes:
      - ./docker/litellm/config.yaml:/app/config.yaml:ro
    ports:
      - "${LITELLM_PORT:-4000}:4000"
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # Git Server (Gitea) - 경량 Git 저장소
  # ===========================================
  gitea:
    image: gitea/gitea:1.21-rootless
    container_name: cursor-poc-gitea
    environment:
      GITEA__server__ROOT_URL: ${GITEA_ROOT_URL:-http://localhost:3001}
      GITEA__server__SSH_DOMAIN: ${GITEA_SSH_DOMAIN:-localhost}
      GITEA__server__SSH_PORT: ${GITEA_SSH_PORT:-2222}
      GITEA__database__DB_TYPE: sqlite3
      GITEA__service__DISABLE_REGISTRATION: "false"
      GITEA__security__INSTALL_LOCK: "false"
    volumes:
      - gitea_data:/var/lib/gitea
      - gitea_config:/etc/gitea
    ports:
      - "${GITEA_HTTP_PORT:-3001}:3000"
      - "${GITEA_SSH_PORT:-2222}:2222"
    networks:
      - cursor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - git

volumes:
  keycloak_data:
  tabby_data:
  gitea_data:
  gitea_config:
  code_server_data:

# 기존 cursor-network 사용
networks:
  cursor-network:
    external: true
    name: cursor-onprem-poc_cursor-network
