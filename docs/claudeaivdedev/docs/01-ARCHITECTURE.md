# 01. 아키텍처 설계서

> **문서 버전**: 2.0  
> **작성일**: 2026-01-03  
> **상태**: Draft

## 1. 개요

### 1.1 목적

금융권 VDE 환경에서 브라우저만으로 Cursor/Copilot 수준의 AI 코딩 환경을 제공하는 시스템 아키텍처를 정의합니다.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **격리 우선** | 사용자별 완전 격리 (1인 1컨테이너/VM) |
| **제로 트러스트** | 모든 접근은 인증/인가 후 허용 |
| **감사 가능성** | 모든 행위는 추적 가능해야 함 |
| **폐쇄망 적합** | 외부 인터넷 의존성 제거 |

## 2. 전체 아키텍처

### 2.1 논리 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              VDE 단말 (브라우저)                              │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │ HTTPS (443)
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         접속 구간 (보안 게이트)                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │    WAF      │→ │   Nginx     │→ │  Keycloak   │→ │  Session    │        │
│  │             │  │   Proxy     │  │  (OIDC/MFA) │  │  Manager    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        ▼                         ▼                         ▼
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│   IDE 존       │       │   AI 존        │       │   소스/빌드 존  │
│               │       │               │       │               │
│ ┌───────────┐ │       │ ┌───────────┐ │       │ ┌───────────┐ │
│ │code-server│ │◄─────►│ │  Tabby    │ │       │ │  GitLab   │ │
│ │(사용자별)  │ │       │ │(자동완성)  │ │       │ │           │ │
│ └───────────┘ │       │ └───────────┘ │       │ └───────────┘ │
│               │       │               │       │               │
│ ┌───────────┐ │       │ ┌───────────┐ │       │ ┌───────────┐ │
│ │ Continue  │ │◄─────►│ │LLM Gateway│ │       │ │  Nexus    │ │
│ │ Extension │ │       │ │(LiteLLM)  │ │       │ │(패키지)    │ │
│ └───────────┘ │       │ └───────────┘ │       │ └───────────┘ │
│               │       │               │       │               │
│               │       │ ┌───────────┐ │       │ ┌───────────┐ │
│               │       │ │vLLM/TRT-LLM│ │       │ │ CI Runner │ │
│               │       │ │(GPU 서버)  │ │       │ │           │ │
│               │       │ └───────────┘ │       │ └───────────┘ │
└───────────────┘       └───────────────┘       └───────────────┘
        │                         │                         │
        └─────────────────────────┼─────────────────────────┘
                                  │
                                  ▼
                    ┌───────────────────────┐
                    │      감사/로그 존       │
                    │  ┌─────────────────┐  │
                    │  │ Elasticsearch   │  │
                    │  │ (SIEM 연동)     │  │
                    │  └─────────────────┘  │
                    └───────────────────────┘
```

### 2.2 존(Zone) 정의

| 존 | 역할 | 주요 컴포넌트 | 보안 수준 |
|----|------|--------------|----------|
| **접속 구간** | 인증, 접근통제, TLS 종단 | WAF, Nginx, Keycloak | 최고 |
| **IDE 존** | 개발 환경 제공 | code-server, 확장 | 높음 |
| **AI 존** | AI 코딩 기능 제공 | Tabby, LLM Gateway, vLLM | 높음 |
| **소스/빌드 존** | 코드 저장, 빌드, 패키지 | GitLab, Nexus, CI | 높음 |
| **감사/로그 존** | 로그 수집, 분석 | Elasticsearch, Kibana | 중간 |

## 3. 컴포넌트 상세

### 3.1 Web IDE 계층

#### code-server

| 항목 | 설명 |
|------|------|
| **역할** | 브라우저에서 VS Code 경험 제공 |
| **배포 모델** | 사용자당 1개 컨테이너 (격리) |
| **리소스 제한** | CPU 2코어, RAM 4GB, Disk 10GB (기본값) |
| **네트워크** | localhost 바인딩, Nginx 프록시를 통해서만 접근 |

#### Continue 확장 호환성 (⚠️ 검증 필수)

> **주의**: code-server에서 모든 VS Code 확장이 동일하게 동작하지 않습니다. PoC 단계에서 반드시 검증해야 합니다.

| 검증 항목 | 예상 이슈 | 대응 방안 |
|----------|----------|----------|
| Continue 확장 설치 | VSIX 수동 설치 필요 | 오프라인 VSIX 배포 |
| WebSocket 통신 | 프록시 설정 필요 | Nginx upgrade 설정 |
| 언어 서버 연동 | 네이티브 바이너리 호환 | 컨테이너 이미지에 포함 |
| 설정 동기화 | 클라우드 동기화 불가 | 로컬 설정 파일로 대체 |

### 3.2 AI 코딩 기능 계층

#### 3.2.1 인라인 자동완성 (Tabby)

| 항목 | 설명 |
|------|------|
| **역할** | Copilot 스타일 코드 자동완성 |
| **성능 목표** | P95 응답시간 150-250ms |
| **배포** | 공유 서버 (GPU 필요) |

**⚠️ 현실적 한계**

원문 문서에서 언급하지 않은 Tabby의 한계점:

| 항목 | Copilot/Cursor | Tabby (self-hosted) |
|------|---------------|---------------------|
| 코드 품질 | 높음 | 모델에 따라 중-상 |
| 컨텍스트 이해 | 우수 (전체 레포) | 제한적 (현재 파일 중심) |
| 지원 언어 | 거의 모든 언어 | 주요 언어 위주 |
| 유지보수 | 자동 | 수동 모델 업데이트 |

**권장 코드 모델**

| 모델 | 파라미터 | GPU VRAM | 용도 | 품질 |
|------|---------|----------|------|------|
| StarCoder2-3B | 3B | 8GB | 빠른 자동완성 | 중 |
| StarCoder2-7B | 7B | 16GB | 균형 | 중상 |
| DeepSeek-Coder-6.7B | 6.7B | 16GB | 균형 | 상 |
| CodeLlama-13B | 13B | 32GB | 고품질 | 상 |

#### 3.2.2 Chat/Edit/Agent (Continue + LLM Gateway)

| 항목 | 설명 |
|------|------|
| **역할** | 대화형 코딩, 리팩토링, 에이전트 기능 |
| **확장** | Continue (VS Code 확장) |
| **백엔드** | LiteLLM Proxy → vLLM |

**권장 Chat 모델**

| 모델 | 파라미터 | GPU | 용도 |
|------|---------|-----|------|
| DeepSeek-Coder-33B-Instruct | 33B | A100 40GB | Chat/Edit |
| CodeLlama-70B-Instruct | 70B | A100 80GB × 2 | 고품질 Chat |
| Qwen2.5-Coder-32B | 32B | A100 40GB | 균형 |

### 3.3 LLM Gateway (⚠️ 구현 복잡도 주의)

> **주의**: 자체 구축 시 상당한 개발 공수가 필요합니다. 오픈소스 솔루션을 권장합니다.

#### 권장 옵션

| 옵션 | 장점 | 단점 | 권장 상황 |
|------|------|------|----------|
| **LiteLLM Proxy** (권장) | 설정 간단, 다중 모델 라우팅 | 커스터마이징 제한 | PoC, Pilot |
| Kong + 커스텀 플러그인 | 유연성 높음 | 개발 공수 | 대규모 운영 |
| 자체 개발 | 완전 제어 | 개발/유지보수 부담 | 특수 요건 |

#### LiteLLM Proxy 기능

```yaml
# litellm_config.yaml 예시
model_list:
  - model_name: autocomplete
    litellm_params:
      model: openai/starcoder2-7b
      api_base: http://tabby-server:8080/v1
    
  - model_name: chat
    litellm_params:
      model: openai/deepseek-coder-33b
      api_base: http://vllm-server:8000/v1

litellm_settings:
  success_callback: ["langfuse"]  # 로깅
  max_budget: 100  # 토큰 예산
  
general_settings:
  master_key: ${LITELLM_MASTER_KEY}
```

### 3.4 Code Intelligence / RAG

#### 옵션 비교

| 옵션 | 비용 | 구축 복잡도 | 기능 |
|------|------|-----------|------|
| **Sourcegraph Enterprise** | 사용자당 $29-99/월 | 낮음 | 전체 기능 |
| **자체 RAG 구축** | 인프라 비용만 | 높음 (2-4주) | 기본 검색 |

#### 자체 RAG 구축 시 구성

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   GitLab    │────►│  Indexer    │────►│   Qdrant    │
│  Webhooks   │     │  (Python)   │     │  (Vector DB)│
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                    Code Embedding
                    (StarEncoder / CodeBERT)
```

**예상 공수**: 2-4주 (전담 엔지니어 1명 기준)

## 4. 네트워크 설계

### 4.1 포트 매트릭스

| 소스 | 목적지 | 포트 | 프로토콜 | 용도 |
|------|--------|------|---------|------|
| VDE 브라우저 | Nginx | 443 | HTTPS | 사용자 접속 |
| Nginx | Keycloak | 8443 | HTTPS | 인증 |
| Nginx | code-server | 8080 | HTTP | IDE 프록시 |
| code-server | Tabby | 8081 | HTTP | 자동완성 |
| code-server | LiteLLM | 4000 | HTTP | Chat API |
| LiteLLM | vLLM | 8000 | HTTP | LLM 추론 |
| code-server | GitLab | 443 | HTTPS | Git 작업 |
| 모든 서버 | Elasticsearch | 9200 | HTTPS | 로깅 |

### 4.2 네트워크 세그먼트

```
┌──────────────────────────────────────────────────────────┐
│                    Management VLAN (10.0.1.0/24)          │
│  - 운영자 접근, 모니터링, 로그 수집                         │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                    DMZ VLAN (10.0.2.0/24)                 │
│  - Nginx, WAF, Keycloak                                  │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                    IDE VLAN (10.0.3.0/24)                 │
│  - code-server 인스턴스들                                 │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                    AI VLAN (10.0.4.0/24)                  │
│  - Tabby, LiteLLM, vLLM (GPU 서버)                       │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                    Backend VLAN (10.0.5.0/24)             │
│  - GitLab, Nexus, CI Runner                              │
└──────────────────────────────────────────────────────────┘
```

## 5. GPU 리소스 배치 가이드

### 5.1 권장 배치 (동시 사용자 50명 기준)

| 용도 | 모델 | 하드웨어 | 수량 | 비고 |
|------|------|---------|------|------|
| 자동완성 (Tabby) | StarCoder2-7B | RTX 5090 (32GB) | 2대 | 저지연 필수 |
| Chat/Edit | DeepSeek-Coder-33B | A100 40GB | 2대 | 고품질 |
| Code Embedding | StarEncoder | CPU or RTX 4090 | 1대 | RAG용 |

### 5.2 스케일 가이드

| 동시 사용자 | Tabby 서버 | Chat 서버 | 총 GPU |
|------------|-----------|----------|--------|
| 20명 | 1 × RTX 5090 | 1 × A100 40GB | 2대 |
| 50명 | 2 × RTX 5090 | 2 × A100 40GB | 4대 |
| 100명 | 3 × RTX 5090 | 3 × A100 40GB | 6대 |

## 6. 고가용성 설계

### 6.1 단일 장애점(SPOF) 제거

| 컴포넌트 | HA 전략 | RPO | RTO |
|---------|--------|-----|-----|
| Nginx | Active-Standby + VIP | 0 | 30초 |
| Keycloak | Active-Active 클러스터 | 0 | 60초 |
| code-server | K8s ReplicaSet | 세션 데이터 | 2분 |
| Tabby | K8s Deployment (2+) | 0 | 30초 |
| vLLM | K8s Deployment (2+) | 0 | 60초 |
| GitLab | 별도 HA 구성 참조 | 1분 | 10분 |

### 6.2 세션 상태 관리

> **⚠️ 원문에서 누락된 중요 사항**

code-server 컨테이너 재시작 시 미저장 작업이 손실될 수 있습니다.

**대응 방안**:

1. **자동 저장**: VS Code 설정으로 1분마다 자동 저장
2. **워크스페이스 영속성**: PVC를 통한 홈 디렉토리 영구 보존
3. **세션 복구**: IDE 재접속 시 마지막 상태 복원

```json
// settings.json
{
  "files.autoSave": "afterDelay",
  "files.autoSaveDelay": 60000
}
```

## 7. 다음 단계

- [보안 통제 명세서](02-SECURITY-CONTROLS.md)에서 상세 보안 요건 확인
- [운영 가이드](03-OPERATIONS-GUIDE.md)에서 운영 절차 확인
- [scaffold/](../scaffold/)에서 실제 배포 코드 확인
